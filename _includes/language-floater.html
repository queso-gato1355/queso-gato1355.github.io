<div class="lang-floater" id="lang-floater">
  <button class="lang-floater__btn" id="lang-floater-btn" aria-haspopup="true" aria-expanded="false">
    <i class="fas fa-globe"></i>
    <span class="lang-text">Language</span>
  </button>
  <ul class="lang-floater__list" id="lang-floater-list">
    <!-- Liquid Logic: Simple & Robust Link Generation -->
    {%- assign current_path = page.url -%}
    {%- assign supported_languages = site.languages -%}
    
    {%- comment -%} 1. 현재 URL에서 모든 언어 접두사를 제거하여 Base Path 추출 {%- endcomment -%}
    {%- for lang in supported_languages -%}
        {%- assign prefix = "/" | append: lang | append: "/" -%}
        {%- if current_path contains prefix -%}
            {%- assign current_path = current_path | replace_first: prefix, "/" -%}
        {%- endif -%}
    {%- endfor -%}
    
    {%- comment -%} 루트 경로 보정 {%- endcomment -%}
    {%- if current_path == "" %}{% assign current_path = "/" %}{% endif -%}

    {%- for language in supported_languages -%}
      {%- comment -%} 2. 링크 생성: 기본 언어는 Base Path, 그 외는 /lang + Base Path {%- endcomment -%}
      {%- if language == site.default_lang -%}
         {%- assign target_url = current_path -%}
      {%- else -%}
         {%- assign target_url = "/" | append: language | append: current_path | replace: '//', '/' -%}
      {%- endif -%}
      
      <li>
        <a {% static_href %}href="{{ target_url | relative_url }}"{% endstatic_href %} 
           class="lang-floater__link {% if language == site.active_lang %}active{% endif %}"
           title="{{ site.data.i18n[language].label }}">
            {{ site.data.i18n[language].icon }} {{ site.data.i18n[language].label }}
        </a>
      </li>
    {%- endfor -%}
  </ul>
</div>

<style>
  .lang-floater {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, "Roboto", "Segoe UI", "Helvetica Neue", "Lucida Grande", Arial, sans-serif;
    transition: bottom 0.1s ease-out; /* Smooth transition for footer collision */
  }

  .lang-floater__btn {
    background-color: #fff;
    color: #494e52;
    border: 1px solid #ccc;
    border-radius: 40px; /* More pill-shaped */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
  }

  .lang-floater__btn:hover {
    background-color: #f8f9fa;
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
  }
  
  .lang-floater__btn:active {
    transform: translateY(1px);
  }

  .lang-floater__list {
    position: absolute;
    bottom: 115%; /* Show above the button */
    left: 0;
    background-color: white;
    border: 1px solid #eee;
    border-radius: 8px;
    list-style: none;
    padding: 8px 0;
    margin: 0;
    min-width: 160px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    display: none;
    flex-direction: column;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.2s, transform 0.2s;
  }

  .lang-floater__list.show {
    display: flex;
    opacity: 1;
    transform: translateY(0);
  }

  .lang-floater__link {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    color: #555;
    text-decoration: none;
    font-size: 14px;
    transition: background-color 0.2s;
  }

  .lang-floater__link:hover {
    background-color: #f0f0f0;
    color: #000;
  }

  .lang-floater__link.active {
    font-weight: bold;
    color: #000;
    background-color: #fafafa;
    cursor: default;
    pointer-events: none;
  }
</style>

<script>
  (function() {
    var floater = document.getElementById('lang-floater');
    var btn = document.getElementById('lang-floater-btn');
    var list = document.getElementById('lang-floater-list');
    var footer = document.getElementById('footer'); // Using the ID we verified in default.html layout
    
    // Toggle Menu
    if (btn && list) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var isExpanded = btn.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                list.classList.remove('show');
                btn.setAttribute('aria-expanded', 'false');
            } else {
                list.classList.add('show');
                btn.setAttribute('aria-expanded', 'true');
            }
        });

        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (!btn.contains(e.target) && !list.contains(e.target)) {
                list.classList.remove('show');
                btn.setAttribute('aria-expanded', 'false');
            }
        });
    }

    // Footer Collision Logic
    if (floater && footer) {
        function adjustPosition() {
            var footerRect = footer.getBoundingClientRect();
            var viewportHeight = window.innerHeight;
            var defaultBottom = 20; // Default distance from bottom

            // Calculate distance from viewport top to footer top
            var footerTop = footerRect.top;

            if (footerTop < viewportHeight) {
                // Footer is entering or inside the viewport
                // We want to keep the floater above the footer with some margin (e.g., 20px)
                var newBottom = (viewportHeight - footerTop) + defaultBottom;
                floater.style.bottom = newBottom + 'px';
            } else {
                // Footer is below viewport
                floater.style.bottom = defaultBottom + 'px';
            }
        }

        // Run on scroll and resize
        window.addEventListener('scroll', adjustPosition);
        window.addEventListener('resize', adjustPosition);
        // Run once initially
        adjustPosition();
        // Run on scroll and resize
        window.addEventListener('scroll', adjustPosition);
        window.addEventListener('resize', adjustPosition);
        // Run once initially
        adjustPosition();
    }
  })();
</script>