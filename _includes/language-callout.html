{%- assign current_lang = site.active_lang | default: "en" -%}
{%- assign current_path = page.url -%}
{%- assign supported_languages = site.languages -%}
{%- assign availability_map = site.data.polyglot_availability -%}

{%- comment -%} 1. Base URL 추출 {%- endcomment -%}
{%- if current_lang != site.default_lang -%}
  {%- assign prefix = "/" | append: current_lang | append: "/" -%}
  {%- if current_path contains prefix -%}
    {%- assign current_path = current_path | replace_first: prefix, "/" -%}
  {%- elsif current_path == "/" | append: current_lang -%}
    {%- assign current_path = "/" -%}
  {%- endif -%}
{%- endif -%}

{%- if current_path == "" %}{% assign current_path = "/" %}{% endif -%}

<div class="notice--info language-callout" style="margin-top: 1em; font-size: 0.9em; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
  <i class="fas fa-language fa-lg"></i>
  <span style="margin: 5px;">Read in other languages:</span>

  {%- for language in supported_languages -%}
    {%- if language != current_lang -%}
      {%- comment -%} Check Availability {%- endcomment -%}
      {%- assign is_available = true -%}
      {%- if page.lang-ref and availability_map -%}
         {%- assign available_langs = availability_map[page.lang-ref] -%}
         {%- unless available_langs contains language -%}
            {%- assign is_available = false -%}
         {%- endunless -%}
      {%- endif -%}

      {%- if is_available -%}
        {%- comment -%} URL 생성 {%- endcomment -%}
        {%- if language == site.default_lang -%}
          {%- assign target_url = current_path -%}
        {%- else -%}
          {%- assign target_url = "/" | append: language | append: current_path | replace: '//', '/' -%}
        {%- endif -%}
        
        <a {% static_href %}href="{{ target_url | relative_url }}"{% endstatic_href %} class="btn" style="padding: 2px 6px; margin: 2px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; font-size: 0.75em; transition: all 0.2s ease; white-space: nowrap;">
          {{ site.data.i18n[language].label }}
        </a>
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
</div>